#!/usr/bin/env nix-shell
#!nix-shell -i bash -p coreutils-full -p gnugrep -p gnused -p sane-scripts.ip-check -p systemd

oper="$1"
region="$2"
# region should be e.g. `us` or `ukr`

vpns=$(systemctl list-unit-files | grep vpn- | cut -f 1 -d ' ' | sed s'/^vpn-\([a-zA-Z-]*\)\.service$/\1/g')

usage() {
  echo "usage:"
  echo "sane-vpn up REGION"
  echo "sane-vpn down REGION"
  echo "sane-vpn help"
  echo ""
  echo "regions:"
  echo "$vpns"
}

verb="cat"
if [ "$oper" == up ]; then
  verb="start"
elif [ "$oper" == down ]; then
  verb="stop"
elif [ "$oper" == help ] || [ "$oper" == --help ] || [ -z "$oper" ]; then
  usage
  exit 0
else
  echo "invalid operation '$oper'"
  usage
  exit 1
fi

if systemctl -q list-unit-files "$region"; then
  service="$region"
elif systemctl -q list-unit-files "vpn-$region.service"; then
  service="vpn-$region.service"
elif systemctl -q list-unit-files "vpn-ovpnd-$region.service"; then
  service="vpn-ovpnd-$region.service"
elif systemctl -q list-unit-files "wg-quick-$region.service"; then
  service="wg-quick-$region.service"
else
  echo "invalid vpn name '$region'"
  echo "choices:"
  echo "$vpns"
  exit 1
fi

echo before: $(sane-ip-check --no-upnp)
sudo systemctl "$verb" "$service"
echo after:  $(sane-ip-check --no-upnp)
